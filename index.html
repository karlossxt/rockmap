<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeRadar - Mapa de la Escena Local</title>
    
    <!-- CSS de Leaflet y Buscador -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.css" />
    
    <style>
        :root {
            --primary: #ff3e3e;
            --dark-card: #1e1e1e;
            --text-light: #ffffff;
        }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: #121212; }
        #map { height: 100vh; width: 100%; }

        /* Panel de Control */
        .ui-panel {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(255, 255, 255, 0.98); padding: 25px;
            border-radius: 16px; width: 280px; box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        h1 { margin: 0 0 5px 0; font-size: 26px; color: #111; letter-spacing: -1px; }
        .tagline { font-size: 12px; color: #666; margin-bottom: 20px; display: block; }

        .btn-geo {
            width: 100%; background: var(--primary); color: white; border: none;
            padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold;
            transition: 0.3s; margin-bottom: 15px;
        }
        .btn-geo:hover { background: #e63535; transform: translateY(-2px); }

        select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-top: 5px; }
        
        /* Ajustes del Buscador para que combine con el dise√±o */
        .leaflet-control-search { 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
            border-radius: 8px !important;
            border: none !important;
        }

        .genre-icon { font-size: 22px; text-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <div class="ui-panel">
        <h1>üì° VibeRadar</h1>
        <span class="tagline">Explora la m√∫sica de tu ciudad</span>
        
        <button class="btn-geo" onclick="findMe()">üìç BANDAS CERCA DE M√ç</button>
        
        <div style="margin-bottom: 15px;">
            <label style="font-weight: bold; font-size: 14px;">Filtrar por Estilo:</label>
            <select id="genreSelect" onchange="renderMarkers()">
                <option value="all">üé∏ Todos los g√©neros</option>
                <option value="Rock">Rock</option>
                <option value="Metal">Metal</option>
                <option value="Indie">Indie</option>
                <option value="Jazz">Jazz</option>
                <option value="Punk">Punk</option>
            </select>
        </div>

        <div style="border-top: 1px solid #eee; padding-top: 10px;">
            <label style="font-size: 14px; cursor: pointer;">
                <input type="checkbox" id="showVenues" checked onchange="renderMarkers()"> Ver Bares y Foros üç∫
            </label>
        </div>
    </div>

    <div id="map"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.js"></script>
    
    <script>
        // 1. CAPAS DE MAPA (D√çA Y NOCHE)
        const darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '¬©CartoDB' });
        const lightMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '¬©CartoDB' });

        const map = L.map('map', {
            center: [19.4326, -99.1332],
            zoom: 13,
            layers: [darkMap]
        });

        const baseMaps = { "üåô Modo Noche": darkMap, "‚òÄÔ∏è Modo D√≠a": lightMap };
        L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);

        // 2. DATOS DE PRUEBA (Venues y Bandas combinados para la b√∫squeda)
        const genreIcons = { "Rock": "üé∏", "Metal": "ü§ò", "Indie": "üéπ", "Jazz": "üé∑", "Punk": "üß∑", "Venue": "üç∫" };
        
        const venues = [
            { name: "Capitan Gallo", type: "Venue", coords: [19.4297, -99.1465], info: "Ayuntamiento 145, Centro" },
            { name: "Multiforo 246", type: "Venue", coords: [19.4129, -99.1661], info: "Quer√©taro 246, Roma Nte." },
            { name: "Dobermann Donceles", type: "Venue", coords: [19.4352, -99.1415], info: "Donceles 12, Centro" },
            { name: "Pub de Floki", type: "Venue", coords: [19.6262, -99.0921], info: "Coacalco, Edomex" }
        ];

        const bands = [
            { name: "Bestia Nocturna", type: "Metal", coords: [19.410, -99.170], info: "Heavy Metal" },
            { name: "Los Ecos", type: "Indie", coords: [19.420, -99.160], info: "Alternative Indie" },
            { name: "Jazz Cats", type: "Jazz", coords: [19.415, -99.168], info: "Bebop & Fusion" }
        ];

        // 3. CAPA DE B√öSQUEDA Y RENDERIZADO
        const markersLayer = L.layerGroup().addTo(map);

        function renderMarkers() {
            markersLayer.clearLayers();
            const selectedGenre = document.getElementById('genreSelect').value;
            const viewVenues = document.getElementById('showVenues').checked;

            // Procesar Venues
            if(viewVenues) {
                venues.forEach(v => {
                    addMarker(v, genreIcons["Venue"]);
                });
            }

            // Procesar Bandas (con seguridad Jitter)
            bands.forEach(b => {
                if(selectedGenre === "all" || b.type === selectedGenre) {
                    const jitter = () => (Math.random() - 0.5) * 0.006;
                    const secureCoords = [b.coords[0] + jitter(), b.coords[1] + jitter()];
                    addMarker({...b, coords: secureCoords}, genreIcons[b.type]);
                }
            });
        }

        function addMarker(data, iconEmoji) {
            const customIcon = L.divIcon({
                className: 'genre-icon',
                html: iconEmoji,
                iconSize: [30, 30]
            });

            const marker = L.marker(data.coords, { 
                icon: customIcon,
                title: data.name // Esto es lo que lee el buscador
            }).bindPopup(`<b>${data.name}</b><br>${data.info}`);
            
            markersLayer.addLayer(marker);
        }

        // 4. CONFIGURAR LA BARRA DE B√öSQUEDA
        const searchControl = new L.Control.Search({
            layer: markersLayer,
            propertyName: 'title', // Busca por el atributo 'title' del marcador
            marker: false,
            moveToLocation: function(latlng, title, map) {
                map.setView(latlng, 16); // Hace zoom al encontrarlo
            }
        });

        searchControl.on('search:locationfound', function(e) {
            e.layer.openPopup();
        });

        map.addControl(searchControl);

        // 5. GEOLOCALIZACI√ìN
        function findMe() {
            map.locate({setView: true, maxZoom: 15});
        }

        map.on('locationfound', e => {
            L.circle(e.latlng, e.accuracy).addTo(map);
            L.marker(e.latlng).addTo(map).bindPopup("Est√°s aqu√≠").openPopup();
        });

        // Inicio
        renderMarkers();
    </script>
</body>
</html>
